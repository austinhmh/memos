# build-push.sh 脚本改进说明

## 改进内容

### 1. 添加详细的构建流程说明

在脚本开头添加了注释，清楚说明整个构建流程：

```bash
# 构建流程说明:
#   1. 构建前端 (web/) -> 输出到 server/router/frontend/dist/
#   2. Docker 构建时，Go 编译器会通过 //go:embed 指令将 dist/ 目录嵌入到二进制文件中
#   3. 最终的 Docker 镜像包含嵌入了前端资源的 Go 二进制文件
```

### 2. 优化步骤输出（从 6 步改为 7 步）

**步骤 1/7: 构建前端资源**
- 说明前端构建产物的输出位置
- 解释 Go embed 如何使用这些文件

**步骤 2/7: 验证前端构建产物**
- 显示构建产物位置
- 显示构建产物大小
- 显示文件数量

**步骤 3/7: 准备 Docker 构建**
- 详细说明 Docker 构建过程中的 4 个关键操作：
  1. 复制源代码（包括 dist/）
  2. Go 编译器读取 //go:embed 指令
  3. 嵌入 dist/ 目录到二进制文件
  4. 生成单一可执行文件

**步骤 4/7: 验证 Docker 镜像构建** (新增)
- 检查镜像是否成功创建
- 显示镜像名称和大小
- 说明镜像包含嵌入的前端资源

**步骤 5/7: 为镜像打标签**

**步骤 6/7: 检查 GitHub Container Registry 登录状态**

**步骤 7/7: 推送镜像到 GitHub Container Registry**

### 3. 添加构建流程总结

在脚本结束时显示完整的构建流程总结：

```
构建流程总结:
  1. ✓ 前端构建完成 (web/ -> server/router/frontend/dist/)
  2. ✓ Go 编译完成 (通过 //go:embed 嵌入前端资源)
  3. ✓ Docker 镜像构建完成
  4. ✓ 推送到 GitHub Container Registry
```

### 4. 创建详细的构建流程文档

新增 `BUILD_PROCESS.md` 文档，包含：
- 完整的构建流程说明
- Go embed 工作原理
- Docker 构建流程详解
- 常见问题解答
- 文件结构说明
- 最佳实践建议

## 示例输出

```bash
$ ./build-push.sh

==========================================
开始构建并推送 Docker 镜像
==========================================
镜像名称: ghcr.io/austinhmh/memos
版本标签: latest
Dockerfile: scripts/Dockerfile
代理: 未设置
==========================================

步骤 1/7: 构建前端资源...
==========================================
说明: 前端构建产物将输出到 server/router/frontend/dist/
      Go 编译时会通过 //go:embed 指令将其嵌入到二进制文件中

安装前端依赖...
[...]

步骤 2/7: 验证前端构建产物...
✓ 前端构建成功！
  构建产物位置: server/router/frontend/dist/
  构建产物大小: 7.4M
  文件数量: 234 个文件

步骤 3/7: 准备 Docker 构建...
==========================================
说明: Docker 构建过程中会执行以下操作:
  1. 复制源代码（包括 server/router/frontend/dist/）到构建容器
  2. Go 编译器读取 frontend.go 中的 //go:embed dist/* 指令
  3. 将 dist/ 目录的所有文件嵌入到 Go 二进制文件中
  4. 生成包含前端资源的单一可执行文件

这可能需要几分钟时间，请耐心等待...
[...]

步骤 4/7: 验证 Docker 镜像构建...
==========================================
✓ Docker 镜像构建成功！
  镜像名称: memos:latest
  镜像大小: 89.2MB
  说明: 该镜像包含了嵌入前端资源的 Go 二进制文件

步骤 5/7: 为镜像打标签...
[...]

步骤 6/7: 检查是否已登录 GitHub Container Registry...
Docker 登录状态已确认

步骤 7/7: 推送镜像到 GitHub Container Registry...
[...]

==========================================
构建和推送完成！
==========================================
镜像地址: ghcr.io/austinhmh/memos:latest

构建流程总结:
  1. ✓ 前端构建完成 (web/ -> server/router/frontend/dist/)
  2. ✓ Go 编译完成 (通过 //go:embed 嵌入前端资源)
  3. ✓ Docker 镜像构建完成
  4. ✓ 推送到 GitHub Container Registry
==========================================

使用以下命令拉取并部署:
  ./pull.sh              # 拉取 latest
  ./pull.sh latest   # 拉取 latest
```

## 为什么需要这些改进？

### 问题背景

之前遇到的卡片显示问题就是因为：
1. 修改了前端代码（修复卡片）
2. 但 Docker 镜像中仍然是旧的前端代码
3. 原因是 Go 的 `//go:embed` 在编译时嵌入的是旧的 `dist/` 目录

### 改进目标

1. **让开发者理解构建流程**：清楚知道前端代码如何被嵌入到 Docker 镜像中
2. **避免类似问题**：明确说明必须先构建前端，再构建 Docker 镜像
3. **提供验证步骤**：在每个关键步骤后验证结果，及早发现问题
4. **文档化知识**：通过 BUILD_PROCESS.md 保存构建流程知识

## 相关文件

- `build-push.sh` - 优化后的构建脚本
- `BUILD_PROCESS.md` - 详细的构建流程文档
- `server/router/frontend/frontend.go` - Go embed 实现
